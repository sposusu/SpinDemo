<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>My first three.js app</title>
		<!--<style>
			body { margin: 0; }
		</style>-->


	</head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
        // Params 
        var axisList = [0, 1, 0];
        var rpm = 1000;
        var initialStateList = [0, 0, 0];
        var resetFlag = true;
    </script>
    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.129.0'
        import {OBJLoader} from 'https://cdn.skypack.dev/three@0.129.0/examples/jsm/loaders/OBJLoader.js'
        import {MTLLoader} from 'https://cdn.skypack.dev/three@0.129.0/examples/jsm/loaders/MTLLoader.js'
        import { STLLoader } from 'https://cdn.skypack.dev/three@0.129.0/examples/jsm/loaders/STLLoader'
        var containerElement = document.getElementById('container');

        var container = document.getElementById('container').getBoundingClientRect();
        // var containerWidth = $(container).width();
        // var containerHeight = $(container).height();
        console.log( 'w' + container.width   + ' ' + ' h ' + container.height);
        THREE.Object3D.DefaultUp.set(0, 0, 1);
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera( 75, container.width / container.height , 0.1, 1000 );
        document.body.appendChild( containerElement );

        const renderer = new THREE.WebGLRenderer();
        const serverUrl = 'http://127.0.0.1:8080';
        // const serverUrl = 'https://sposusu.github.io/SpinDemo/';

        renderer.setSize( container.width , container.height  );
        containerElement.appendChild( renderer.domElement );
        // object
        var box;
        var pivot;
        var cube;
        var mtlLoader = new MTLLoader();

        mtlLoader.load( serverUrl + '/assets/10483_baseball_v1_L3.mtl', function( materials ) {

        materials.preload();

        var objLoader = new OBJLoader();
        // var objLoader = new STLLoader()
        objLoader.setMaterials( materials );
        // instantiate a loader
        // load a resource
        objLoader.load(
            // resource URL
            serverUrl + '/assets/10483_baseball_v1_L3.obj',
            // called when resource is loaded
            function ( object ) {
                var texture = new THREE.TextureLoader().load( serverUrl +'/assets/10483_baseball_diffuse.jpg');

                object.traverse(function (child) {   // aka setTexture
                    if (child instanceof THREE.Mesh) {
                        child.material.map = texture;
                    }
                });
                cube = object;
                box = new THREE.Box3().setFromObject( cube );
                box.getCenter( cube.position ); // this re-sets the mesh position
                cube.position.multiplyScalar( - 1 );
                pivot = new THREE.Group();
                scene.add( pivot );
                pivot.add(cube);
                // Calibrate ball to our rotation model
                // pivot.rotation.setFromVector3(new THREE.Vector3( 0, 0, Math.PI));
            },
            // called when loading is in progresses
            function ( xhr ) {

                console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );

            },
            // called when loading has errors
            function ( error ) {

                console.log( 'An error happened' + error );

            }
        );
        });

        // const geometry = new THREE.BoxGeometry();
        // const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
        // cube = new THREE.Mesh( geometry, material );
        // scene.add( cube );
        // camera.position.z = 50;
        camera.position.x = 50;
        camera.lookAt(new THREE.Vector3(0, 0, 0));


        let ambientLight = new THREE.AmbientLight(0xffffff)
        scene.add(ambientLight)
        var animate = function () {
            requestAnimationFrame( animate );
            if (resetFlag) {
                // pivot.rotation.setFromVector3(new THREE.Vector3( 0, 0, Math.PI));
                pivot.rotation.setFromVector3(new THREE.Vector3( 0, 0, 0));

                pivot.rotateX(initialStateList[0]/180 *Math.PI);
                pivot.rotateY(initialStateList[1]/180 *Math.PI);
                pivot.rotateZ(initialStateList[2]/180 *Math.PI);
                resetFlag = false;
            }

            const yQuaternion = new THREE.Quaternion();
            var yax = new THREE.Vector3(axisList[0], axisList[1], axisList[2]);
            yax = new THREE.Vector3(axisList[0]/yax.length(), axisList[1]/yax.length(), axisList[2]/yax.length());
            pivot.rotateOnWorldAxis(yax, rpm/50000);
            // Multiply the ellipse's rotation with the y-axis rotation
            // cube.quaternion.multiply(yQuaternion);
            
            // cube.rotation.x += 0.01;
            // cube.rotation.y += 0.01;
            console.log('rotate');
            renderer.render( scene, camera );
        };
        animate();


    </script>
    <script>
        function setParams() {
            var form = document.getElementById('form');
            var axis = document.getElementById('axis').value;
            axis = axis.substring(1, axis.length - 1); // cut out the brackets
            axisList = axis.split(" ").filter(function(i){return true;}).map(Number);

            console.log(axisList);
            rpm = document.getElementById('rpm').value;
            console.log(rpm);
            var initialState = document.getElementById('initialState').value;
            initialState = initialState.substring(1, initialState.length - 1); // cut out the brackets
            initialStateList = initialState.split(" ").filter(function(i){return true;}).map(Number);
            console.log(initialStateList);
            resetFlag = true;
        }
    </script>
	<body>
        <div id="container" style="float:left;width:50%;height:100vh">

    
        </div>
        <div id="inputParam" style="float:right;width:40%;height:100vh">
            <form id="form" submit="">
                <label for="axis">Axis: </label>
                <input type="text" id="axis" name="axis" size="40" value="[0 1 0]"><br><br>
                <label for="rpm">Initial State: </label>
                <input type="text" id="initialState" name="initialState" size="40" value="[0 0 0]"><br><br>
                <label for="rpm">rpm: </label>
                <input type="number" id="rpm" name="rpm" value="1000"><br><br>
                <input type="button" value="Submit" onclick="setParams()">
              </form>
        </div>
       
	</body>
</html>